<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AR Model with Delhi AQI Overlay</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- A-Frame and AR.js -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>
<script src="https://cdn.jsdelivr.net/gh/IdeaSpaceVR/aframe-particle-system-component@1.0.1/dist/aframe-particle-system-component.min.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: sans-serif; }
a-scene { height: 100%; width: 100%; }

#overlay {
    position: absolute;
    top: 10px;
    left: 10px;
    width: 350px;
    max-height: 90%;
    background: rgba(255,255,255,0.9);
    border-radius: 12px;
    padding: 10px;
    overflow-y: auto;
    z-index: 10;
}

#map {
    height: 300px;
    width: 100%;
    border-radius: 10px;
    margin-top: 10px;
}

#controls {
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    background: rgba(240,240,240,0.8);
    padding: 10px;
    border-radius: 12px;
    z-index: 10;
}

button {
    width: 160px;
    padding: 8px;
    margin: 5px;
    font-size: 14px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    background-color: #007bff;
    color: white;
    transition: background 0.2s;
}

button:hover { background-color: #0056b3; }

#info-box {
    margin-top: 10px;
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 14px;
    text-align: center;
    width: 160px;
    min-height: 50px;
    opacity: 0;
    display: none;
    transition: opacity 0.5s ease;
}

#air-quality-text {
    display: none;
    font-size: 15px;
    line-height: 1.5;
    margin-top: 10px;
}
</style>
</head>
<body>

<a-scene
    vr-mode-ui="enabled: false"
    embedded
    renderer="logarithmicDepthBuffer: true;"
    arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;">

    <a-light type="ambient" intensity="1"></a-light>
    <a-light type="directional" intensity="0.8" position="1 1 1"></a-light>

    <a-entity id="myModel"
          gltf-model="url(models/d.glb)"
          position="0 0 -2"
          rotation="0 180 0">
    </a-entity>

    <a-camera></a-camera>
</a-scene>

<div id="controls">
  <button onclick="setView('land')">Land Use & Zoning</button>
  <button onclick="setView('transport')">Transport & Traffic</button>
  <button onclick="setView('population')">Population Density</button>
  <button onclick="setView('industry')">Industrial & Economic Hubs</button>
  <button onclick="setView('health')">Health & Education</button>
  <button onclick="setView('public')">Public Services</button>
  <button onclick="setView('disaster')">Disaster Risk</button>
  <button onclick="setView('renewable')">Renewable Energy</button>
  <button onclick="showAirQuality()">Air Quality</button>
  <div id="info-box"></div>
</div>

<div id="overlay">
    <h2>Delhi Air Quality</h2>
    <div id="map">Loading map...</div>
    <div id="air-quality-text">
        <p><strong>Air Quality in Delhi:</strong><br>
        Delhi faces one of the highest air pollution levels in the world, largely due to vehicular emissions, industrial pollution, and seasonal crop burning. 
        The Air Quality Index (AQI) often ranges between 200–400 during peak months, categorizing it as “poor” to “very poor.” 
        Efforts such as the Graded Response Action Plan (GRAP) and the expansion of the Delhi Metro aim to reduce pollution. 
        Residents are encouraged to use masks and air purifiers, and avoid outdoor activity during high smog periods.</p>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const model = document.querySelector('#myModel');
const infoBox = document.querySelector('#info-box');
const overlay = document.querySelector('#overlay');
const mapDiv = document.querySelector('#map');
const airQualityText = document.querySelector('#air-quality-text');

const views = {
  land: {
    rotation: {x:0, y:180, z:0},
    info: "Land Use & Zoning: Delhi has ~1,484 km² urban area. The city is divided into residential, commercial, industrial, and green zones. Central Delhi and South Delhi are mostly residential and commercial, while Rohini and Okhla host industrial zones."
  },
  transport: {
    rotation: {x:0, y:90, z:0},
    info: "Transport & Traffic: Delhi has 11 metro lines (Delhi Metro), ~14,000 km of roads, and over 10 million registered vehicles. Main traffic congestion occurs in Connaught Place, Karol Bagh, and Ring Road corridors."
  },
  population: {
    rotation: {x:0, y:270, z:0},
    info: "Population Density: Delhi has ~20 million residents (2023), making it one of the densest cities in the world (~11,000 people/km²). North and East Delhi have the highest population density."
  },
  industry: {
    rotation: {x:0, y:0, z:0},
    info: "Industrial & Economic Hubs: Key hubs include Okhla Industrial Area, Mayapuri, Patparganj, and Gurgaon (NCR). Major sectors: IT, manufacturing, textiles, and pharmaceuticals."
  },
  health: {
    rotation: {x:0, y:45, z:0},
    info: "Health & Education: Delhi has 250+ hospitals including AIIMS, Safdarjung, and Fortis. Education institutions include Delhi University, Jawaharlal Nehru University, and over 1,500 schools."
  },
  public: {
    rotation: {x:0, y:135, z:0},
    info: "Public Services & Infrastructure: Delhi is served by MCD and DDA utilities, over 1,000 police stations, metro and bus networks, 10+ wastewater treatment plants, and robust civic infrastructure."
  },
  disaster: {
    rotation: {x:0, y:225, z:0},
    info: "Disaster Risk & Resilience: Delhi is moderately prone to earthquakes (Zone IV), floods along Yamuna, and heatwaves. Disaster management is coordinated by the Delhi Disaster Management Authority (DDMA)."
  },
  renewable: {
    rotation: {x:0, y:315, z:0},
    info: "Renewable Energy & Sustainability: Delhi has 230 MW solar power installations (rooftops & parks) and several EV charging stations. Solar water heating and energy efficiency programs are ongoing in residential and commercial areas."
  }
};

function setView(viewName) {
  if (views[viewName]) {
    const v = views[viewName];
    model.setAttribute('rotation', v.rotation);
    infoBox.textContent = v.info;
    infoBox.style.display = 'block';
    infoBox.style.opacity = '1';
    airQualityText.style.display = 'none';
    mapDiv.style.display = 'none';
    document.body.style.backgroundColor = 'white';
  }
}


// Show Air Quality text and reveal AQI map
function showAirQuality() {
  mapDiv.style.display = "block";
  airQualityText.style.display = "block";
  infoBox.style.display = "none";

  fetch(cityUrl)
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        const aqi = data.data.aqi;
        const city = data.data.city.name;
        let description = "";
        let color = "";

        if (aqi <= 50) { description = "Good"; color = "lightgreen"; }
        else if (aqi <= 100) { description = "Moderate"; color = "yellow"; }
        else if (aqi <= 150) { description = "Unhealthy for Sensitive Groups"; color = "orange"; }
        else if (aqi <= 200) { description = "Unhealthy"; color = "gold"; }
        else if (aqi <= 300) { description = "Very Unhealthy"; color = "red"; }
        else { description = "Hazardous"; color = "darkred"; }

        document.body.style.backgroundColor = color;

        airQualityText.innerHTML = `
          <strong>Current Air Quality in ${city}</strong><br>
          AQI: <strong>${aqi}</strong> (${description})<br><br>
          ${getHealthAdvice(aqi)}
        `;

        const map = L.map('map').setView([28.6139, 77.2090], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        L.marker([28.6139, 77.2090])
          .addTo(map)
          .bindPopup(`<b>Delhi</b><br>AQI: ${aqi} (${description})`)
          .openPopup();
      } else {
        airQualityText.textContent = "Error fetching air quality data.";
      }
    })
    .catch(() => {
      airQualityText.textContent = "Error loading air quality data.";
    });
}

// Initially hide the AQI map
mapDiv.style.display = "none";

// =====================
// Delhi AQI Map Section
// =====================
const token = '312f38a7905aff78272922fdac617772d91fd516';
const bounds = [28.4,76.9,28.9,77.3];
const mapUrl = `https://api.waqi.info/map/bounds/?latlng=${bounds.join(',')}&token=${token}`;

fetch(mapUrl)
  .then(res => res.json())
  .then(data => {
      if(data.status === "ok"){
          const map = L.map('map').setView([28.6139, 77.2090], 11);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          data.data.forEach(station => {
              const lat = station.lat;
              const lon = station.lon;
              const aqi = station.aqi;
              const name = station.station.name;
              const marker = L.marker([lat, lon]).addTo(map);
              marker.bindPopup(`<strong>${name}</strong><br>AQI: ${aqi}`);
          });
      } else {
          document.getElementById('map').innerHTML = 'Error loading AQI map.';
      }
  })
  .catch(err => {
      console.error(err);
      document.getElementById('map').innerHTML = 'Error loading AQI map.';
  });
function showAirQuality() {
  mapDiv.style.display = "block";
  airQualityText.style.display = "block";
  infoBox.style.display = "none";

  fetch(cityUrl)
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        const aqi = data.data.aqi;
        const city = data.data.city.name;
        let description = "";
        let color = "";

        if (aqi <= 50) { description = "Good"; color = "lightgreen"; }
        else if (aqi <= 100) { description = "Moderate"; color = "yellow"; }
        else if (aqi <= 150) { description = "Unhealthy for Sensitive Groups"; color = "orange"; }
        else if (aqi <= 200) { description = "Unhealthy"; color = "gold"; }
        else if (aqi <= 300) { description = "Very Unhealthy"; color = "red"; }
        else { description = "Hazardous"; color = "darkred"; }

        document.body.style.backgroundColor = color;

        airQualityText.innerHTML = `
          <strong>Current Air Quality in ${city}</strong><br>
          AQI: <strong>${aqi}</strong> (${description})<br><br>
          ${getHealthAdvice(aqi)}
        `;

        const map = L.map('map').setView([28.6139, 77.2090], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        L.marker([28.6139, 77.2090])
          .addTo(map)
          .bindPopup(`<b>Delhi</b><br>AQI: ${aqi} (${description})`)
          .openPopup();
      } else {
        airQualityText.textContent = "Error fetching air quality data.";
      }
    })
    .catch(() => {
      airQualityText.textContent = "Error loading air quality data.";
    });
}

function getHealthAdvice(aqi) {
  if (aqi <= 50) return "Air quality is satisfactory, and air pollution poses little or no risk.";
  if (aqi <= 100) return "Air quality is acceptable, but there may be concern for sensitive individuals.";
  if (aqi <= 150) return "Members of sensitive groups may experience health effects. Limit outdoor activity.";
  if (aqi <= 200) return "Everyone may begin to experience health effects. Avoid prolonged outdoor exertion.";
  if (aqi <= 300) return "Health warnings of emergency conditions. Avoid outdoor activities.";
  return "Hazardous conditions. Stay indoors and use air purifiers if possible.";
}

// Hide map initially
mapDiv.style.display = "none";

// =====================
// Scale Model to Fit Screen
// =====================
model.addEventListener('model-loaded', () => {
    const mesh = model.getObject3D('mesh');
    if (!mesh) return;

    const box = new THREE.Box3().setFromObject(mesh);
    const size = box.getSize(new THREE.Vector3());
    const maxDimension = Math.max(size.x, size.y, size.z);
    const targetSize = 2.5;
    const scaleFactor = targetSize / maxDimension;

    model.setAttribute('scale', `${scaleFactor} ${scaleFactor} ${scaleFactor}`);

    const center = box.getCenter(new THREE.Vector3());
    model.object3D.position.y -= center.y * scaleFactor - 1.5;
});
</script>
</body>
</html>
